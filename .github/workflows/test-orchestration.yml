# Test Orchestration Pipeline
# Complete CI/CD pipeline for API, E2E, and Performance testing

name: Test Orchestration Pipeline

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]
  workflow_dispatch: # Allow manual trigger

jobs:
  # ===== Build Environment =====
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build TypeScript
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 1

  # ===== Seed Test Data =====
  seed:
    name: ðŸŒ± Seed Data
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Seed database
        run: npm run seed
      
      - name: Upload seeded database
        uses: actions/upload-artifact@v4
        with:
          name: test-database
          path: data/
          retention-days: 1

  # ===== API Tests =====
  api-tests:
    name: ðŸ”Œ API Tests
    runs-on: ubuntu-latest
    needs: seed
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download seeded database
        uses: actions/download-artifact@v4
        with:
          name: test-database
          path: data/
      
      - name: Run API tests
        run: npm run test:api -- --ci --coverage
        continue-on-error: true
      
      - name: Upload API test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: |
            reports/api/
            reports/coverage/
          retention-days: 30

  # ===== E2E Tests =====
  e2e-tests:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    needs: api-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Download seeded database
        uses: actions/download-artifact@v4
        with:
          name: test-database
          path: data/
      
      - name: Run E2E tests
        run: npm run test:e2e -- --project=chromium
        continue-on-error: true
      
      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            reports/e2e/
            test-results/
            playwright-report/
          retention-days: 30

  # ===== Performance Tests =====
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: e2e-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download seeded database
        uses: actions/download-artifact@v4
        with:
          name: test-database
          path: data/
      
      - name: Create reports directory
        run: mkdir -p reports/performance
      
      - name: Build and start application server
        run: |
          npm run build
          node dist/src/app/server.js &
          echo "Waiting for server to start..."
          sleep 15
          curl -f http://localhost:3000/api/health || exit 1
          echo "Server is ready!"
        env:
          PORT: 3000
          NODE_ENV: production
      
      - name: Install K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6 -y
      
      - name: Run load tests
        run: k6 run --duration 30s --vus 5 tests/performance/load-test.js
        continue-on-error: true
        env:
          BASE_URL: http://localhost:3000
      
      - name: Upload performance test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-results
          path: reports/performance/
          retention-days: 30
          if-no-files-found: warn

  # ===== Generate Unified Report =====
  generate-report:
    name: ðŸ“Š Generate Report
    runs-on: ubuntu-latest
    needs: [api-tests, e2e-tests, performance-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create report directories
        run: mkdir -p reports/api reports/e2e reports/performance
      
      - name: Download API test results
        uses: actions/download-artifact@v4
        with:
          name: api-test-results
          path: reports/
        continue-on-error: true
      
      - name: Download E2E test results
        uses: actions/download-artifact@v4
        with:
          name: e2e-test-results
          path: reports/
        continue-on-error: true
      
      - name: Download performance test results
        uses: actions/download-artifact@v4
        with:
          name: performance-test-results
          path: reports/performance/
        continue-on-error: true
      
      - name: Generate unified report
        run: npm run report:generate
      
      - name: Upload unified report
        uses: actions/upload-artifact@v4
        with:
          name: unified-test-report
          path: reports/
          retention-days: 90

  # ===== Deploy Report to GitHub Pages =====
  deploy-report:
    name: ðŸš€ Deploy Report
    runs-on: ubuntu-latest
    needs: generate-report
    if: github.ref == 'refs/heads/master' && needs.generate-report.result == 'success'
    continue-on-error: true  # Don't fail workflow if Pages not configured
    
    permissions:
      pages: write
      id-token: write
      contents: read
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Download unified report
        uses: actions/download-artifact@v4
        with:
          name: unified-test-report
          path: reports/
      
      - name: Create index.html redirect
        run: |
          cat > reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Test Report</title>
            <meta http-equiv="refresh" content="0; url=unified-report.html">
            <link rel="canonical" href="unified-report.html">
          </head>
          <body>
            <p>Redirecting to <a href="unified-report.html">Test Report</a>...</p>
          </body>
          </html>
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
        continue-on-error: true
      
      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: reports/
        continue-on-error: true
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        continue-on-error: true
      
      - name: Output Pages URL
        run: |
          echo "## ðŸ“Š Test Report Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Report URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [Unified Report](${{ steps.deployment.outputs.page_url }}unified-report.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [E2E Report](${{ steps.deployment.outputs.page_url }}e2e/index.html)" >> $GITHUB_STEP_SUMMARY
        if: steps.deployment.outputs.page_url != ''

  # ===== Notify on Failure =====
  notify:
    name: ðŸ“§ Notify
    runs-on: ubuntu-latest
    needs: [api-tests, e2e-tests, performance-tests]
    if: failure()
    
    steps:
      - name: Create failure summary
        run: |
          echo "## âŒ Test Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more test stages failed. Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Failed Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- API Tests: ${{ needs.api-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
